name: Get Changed Folder

on:
  push:
    branches:
      - ItzhakBokris/changes-script

jobs:
  get_changed_folder:
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
          ref: ItzhakBokris/changes-script

      - name: Find changed folder
        id: find_changed_folder
        run: |
          # Use git to get the list of changed files
          changed_files=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})

          # Initialize an empty array to store unique directory names
          changed_folders=()
  
          # Loop through the changed files to find the folders
          for file in $changed_files; do
            # Extract the folder path
            folder=$(dirname "$file")

            # Get the first part of the directory path (the first folder)
            base_folder=$(echo "$folder" | cut -d'/' -f1)
                    
            # Check if the file being processed is the workflow YAML file, and skip it
            if [[ "$base_folder" == ".github" ]]; then
              continue
            fi
                    
            # Add the directory to the array if it's not already in the array
            if [[ ! " ${changed_folders[@]} " =~ " ${base_folder} " ]]; then
              changed_folders+=("$base_folder")
            fi
          done
          
          # Set the output variable with the list of changed folders
          echo "::set-output name=changed_folders::${changed_folders[*]}"

      - name: Use the changed folders
        run: |
          # Access the changed folders from the previous step's output
          changed_folders="${{ steps.find_changed_folder.outputs.changed_folders }}"
   
          # Make an API requests with the extracted folders as query parameters
          for folder in $changed_folders; do     
            curl -X GET "https://savenetworkrequest-zbrmx4rjia-uc.a.run.app?dir=$folder"          
          done
